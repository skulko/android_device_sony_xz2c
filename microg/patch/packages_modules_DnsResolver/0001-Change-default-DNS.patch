From 50a7abc5cd809d6acc2bca34d9c2dd2e535e4a4d Mon Sep 17 00:00:00 2001
From: LRX <23030592+skulko@users.noreply.github.com>
Date: Sat, 3 Sep 2022 11:13:32 +0200
Subject: [PATCH] [Patch] Change default DNS

Change-Id: I77308dcaba7b78ee805e10da518516fa26878598
---
 doh.rs                            | 4 ++--
 getaddrinfo.cpp                   | 2 +-
 tests/dnsresolver_binder_test.cpp | 2 +-
 tests/doh_ffi_test.cpp            | 2 +-
 4 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/doh.rs b/doh.rs
index 4f43b7f..3cde3ed 100644
--- a/doh.rs
+++ b/doh.rs
@@ -562,8 +562,8 @@ mod tests {
         );
     }
 
-    const GOOGLE_DNS_URL: &str = "https://dns.google/dns-query";
-    const GOOGLE_DNS_IP: &str = "8.8.8.8";
+    const GOOGLE_DNS_URL: &str = "https://cloudflare-dns.com/dns-query";
+    const GOOGLE_DNS_IP: &str = "1.1.1.1";
     // qtype: A, qname: www.example.com
     const SAMPLE_QUERY: &str = "q80BAAABAAAAAAAAA3d3dwdleGFtcGxlA2NvbQAAAQAB";
     #[test]
diff --git a/getaddrinfo.cpp b/getaddrinfo.cpp
index 23e7e44..05244fd 100644
--- a/getaddrinfo.cpp
+++ b/getaddrinfo.cpp
@@ -250,7 +250,7 @@ static int have_ipv6(unsigned mark, uid_t uid) {
 static int have_ipv4(unsigned mark, uid_t uid) {
     static const struct sockaddr_in sin_test = {
             .sin_family = AF_INET,
-            .sin_addr.s_addr = __constant_htonl(0x08080808L)  // 8.8.8.8
+            .sin_addr.s_addr = __constant_htonl(0x01010101L)  // 1.1.1.1
     };
     sockaddr_union addr = {.sin = sin_test};
     return _find_src_addr(&addr.sa, NULL, mark, uid) == 1;
diff --git a/tests/dnsresolver_binder_test.cpp b/tests/dnsresolver_binder_test.cpp
index 55a67e1..b595be0 100644
--- a/tests/dnsresolver_binder_test.cpp
+++ b/tests/dnsresolver_binder_test.cpp
@@ -413,7 +413,7 @@ TEST_F(DnsResolverBinderTest, RegisterEventListener_onDnsEvent) {
 
 // TODO: Need to test more than one server cases.
 TEST_F(DnsResolverBinderTest, SetResolverConfiguration_Tls) {
-    const std::vector<std::string> LOCALLY_ASSIGNED_DNS{"8.8.8.8", "2001:4860:4860::8888"};
+    const std::vector<std::string> LOCALLY_ASSIGNED_DNS{"1.1.1.1", "2606:4700:4700::1111"};
     static const std::vector<std::string> valid_v4_addr = {"192.0.2.1"};
     static const std::vector<std::string> valid_v6_addr = {"2001:db8::2"};
     static const std::vector<std::string> invalid_v4_addr = {"192.0.*.5"};
diff --git a/tests/doh_ffi_test.cpp b/tests/doh_ffi_test.cpp
index 5004156..f9679c4 100644
--- a/tests/doh_ffi_test.cpp
+++ b/tests/doh_ffi_test.cpp
@@ -21,7 +21,7 @@
 
 TEST(DoHFFITest, SmokeTest) {
     EXPECT_STREQ(doh_init(), "1.0");
-    DohServer* doh = doh_new("https://dns.google/dns-query", "8.8.8.8", 0, "");
+    DohServer* doh = doh_new("https://cloudflare-dns.com/dns-query", "1.1.1.1", 0, "");
     EXPECT_TRUE(doh != nullptr);
 
     // www.example.com
-- 
2.35.1

